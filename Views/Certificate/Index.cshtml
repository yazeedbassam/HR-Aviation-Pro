@model WebApplication1.Models.CertificateIndexViewModel

@{
    ViewData["Title"] = "Documents & Certificates & Others";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Add any shared styles here */
    .custom-card {
        max-width: 99vw;
        margin: 18px auto 5px auto;
        border-radius: 11px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .main-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #146c43;
    }

    .nav-tabs .nav-link.active {
        color: #146c43;
        font-weight: 600;
    }

    .modal-body .details-list li {
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .modal-body .details-list .detail-label {
        font-weight: 600;
        min-width: 120px;
        display: inline-block;
    }
</style>

<div class="container-fluid">
    <div class="card custom-card bg-white px-3 py-4">
        <!-- Header with Title and Global Buttons -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div class="main-header">
                <i class="fa-solid fa-certificate me-2"></i>
                @ViewData["Title"]
            </div>
            <div>
                @if (Html.HasAdvancedPermission("CONTROLLERCERTIFICATE_ADD") || Html.IsAdvancedAdmin())
                {
                    <a href="@Url.Action("Create", "Certificate", new { tab = "controllers" })" class="btn btn-success btn-sm me-2" id="add-controller-certificate">
                        <i class="fa-solid fa-plus"></i> Add New
                    </a>
                }
                @if (Html.HasAdvancedPermission("EMPLOYEECERTIFICATE_ADD") || Html.IsAdvancedAdmin())
                {
                    <a href="@Url.Action("Create", "Certificate", new { tab = "employees" })" class="btn btn-success btn-sm me-2" id="add-employee-certificate" style="display: none;">
                        <i class="fa-solid fa-plus"></i> Add Employee Certificate
                    </a>
                }
                <a href="/" class="btn btn-secondary btn-sm">
                    <i class="fa-solid fa-house"></i> Home
                </a>
            </div>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
        }

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="certificateTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="controllers-cert-tab" data-bs-toggle="tab" data-bs-target="#controllers-cert-pane" type="button" role="tab">Controllers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="employees-cert-tab" data-bs-toggle="tab" data-bs-target="#employees-cert-pane" type="button" role="tab">Employees & Operation Staff</button>
            </li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content pt-2" id="certificateTabContent">
            <div class="tab-pane fade show active" id="controllers-cert-pane" role="tabpanel">
                @await Html.PartialAsync("_ControllerCertificatesPartial", Model.ControllerCertificates)
            </div>
            <div class="tab-pane fade" id="employees-cert-pane" role="tabpanel">
                @await Html.PartialAsync("_EmployeeCertificatesPartial", Model.EmployeesAndOpsStaffCertificates)
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="certificateDetailsModal" tabindex="-1" aria-labelledby="certificateDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="certificateDetailsModalLabel">Certificate Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="details-list">
                    <li><span class="detail-label">Person:</span> <span id="modalPersonName"></span></li>
                    <li><span class="detail-label">Job/Department:</span> <span id="modalPersonJob"></span></li>
                    <hr />
                    <li><span class="detail-label">Type:</span> <span id="modalType"></span></li>
                    <li><span class="detail-label">Title:</span> <span id="modalTitle"></span></li>
                    <li><span class="detail-label">Issue Date:</span> <span id="modalIssueDate"></span></li>
                    <li><span class="detail-label">Expiry Date:</span> <span id="modalExpiryDate"></span></li>
                    <li><span class="detail-label">Status:</span> <span id="modalStatus"></span></li>
                    <li><span class="detail-label">Notes:</span> <span id="modalNotes"></span></li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function getExportUrl(personType, action) {
            let tableId;
            switch(personType) {
                case 'Controller':
                    tableId = '#controllerCertsTable';
                    break;
                case 'Employees':
                    tableId = '#employeesCertsTable';
                    break;
                default:
                    tableId = '#employeesCertsTable';
            }
            
            const filterInputs = document.querySelectorAll(`${tableId} .filters .filter-input`);
            const params = new URLSearchParams();
            filterInputs.forEach(input => {
                const value = input.value.trim();
                const paramName = input.getAttribute('data-param-name');
                if (value !== '' && paramName) params.append(paramName, value);
            });
            params.append('personType', personType);
            return `/Certificate/${action}?${params.toString()}`;
        }

        function exportToFile(personType, action, fileExtension) {
            const url = getExportUrl(personType, action);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.setAttribute('download', `${personType}_Documents_Report_${new Date().toISOString().slice(0, 10)}.${fileExtension}`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Tab switching logic for buttons
        document.addEventListener('DOMContentLoaded', function() {
            const controllersTab = document.getElementById('controllers-cert-tab');
            const employeesTab = document.getElementById('employees-cert-tab');
            const addControllerCertificate = document.getElementById('add-controller-certificate');
            const addEmployeeCertificate = document.getElementById('add-employee-certificate');

            function updateButtons(activeTab) {
                if (activeTab === 'controllers') {
                    addControllerCertificate.style.display = 'inline-block';
                    addEmployeeCertificate.style.display = 'none';
                } else {
                    addControllerCertificate.style.display = 'none';
                    addEmployeeCertificate.style.display = 'inline-block';
                }
            }

            // Listen for tab changes
            controllersTab.addEventListener('click', () => updateButtons('controllers'));
            employeesTab.addEventListener('click', () => updateButtons('employees'));

            // Set initial state
            updateButtons('controllers');
        });

        // Modal logic
        const certificateDetailsModal = document.getElementById('certificateDetailsModal');
        if (certificateDetailsModal) {
            certificateDetailsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;

                document.getElementById('modalType').textContent = button.getAttribute('data-type') || "-";
                document.getElementById('modalPersonName').textContent = button.getAttribute('data-personname') || "-";
                document.getElementById('modalPersonJob').textContent = button.getAttribute('data-personjob') || "-";
                document.getElementById('modalTitle').textContent = button.getAttribute('data-title') || "-";
                document.getElementById('modalIssueDate').textContent = button.getAttribute('data-issuedate') || "-";
                document.getElementById('modalExpiryDate').textContent = button.getAttribute('data-expirydate') || "-";
                document.getElementById('modalStatus').textContent = button.getAttribute('data-status') || "-";
                document.getElementById('modalNotes').textContent = button.getAttribute('data-notes') || "-";
            });
        }
    </script>
}
