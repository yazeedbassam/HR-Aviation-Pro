@model List<WebApplication1.Services.UserPermissionSummaryModel>
@{
    ViewData["Title"] = "حذف المستخدمين";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h3 class="card-title">
                        <i class="fas fa-trash-alt"></i>
                        حذف المستخدمين
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>تحذير:</strong> حذف المستخدمين سيمحي جميع بياناتهم وصلاحياتهم نهائياً!
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="usersTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" />
                                    </th>
                                    <th>المستخدم</th>
                                    <th>الاسم الكامل</th>
                                    <th>الدور</th>
                                    <th>صلاحيات القائمة</th>
                                    <th>صلاحيات العمليات</th>
                                    <th>صلاحيات الهيكل التنظيمي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model)
                                {
                                    <tr data-user-id="@user.UserId">
                                        <td>
                                            <input type="checkbox" class="user-checkbox" value="@user.UserId" 
                                                   @(user.RoleName == "Admin" ? "disabled" : "") />
                                        </td>
                                        <td>@user.Username</td>
                                        <td>@user.FullName</td>
                                        <td>
                                            <span class="badge badge-@(user.RoleName == "Admin" ? "danger" : 
                                                                      user.RoleName == "Controller" ? "info" : 
                                                                      user.RoleName == "Employee" ? "primary" : "secondary")">
                                                @user.RoleName
                                            </span>
                                        </td>
                                        <td>@user.MenuPermissionsCount</td>
                                        <td>@user.OperationPermissionsCount</td>
                                        <td>@user.OrganizationalPermissionsCount</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger delete-single-user" 
                                                    data-user-id="@user.UserId" 
                                                    data-username="@user.Username"
                                                    @(user.RoleName == "Admin" ? "disabled" : "")>
                                                <i class="fas fa-trash"></i> حذف
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-danger" id="deleteSelectedUsers" disabled>
                            <i class="fas fa-trash"></i>
                            حذف المحددين (<span id="selectedCount">0</span>)
                        </button>
                        <button class="btn btn-secondary ml-2" onclick="location.reload()">
                            <i class="fas fa-refresh"></i>
                            تحديث
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    تأكيد الحذف
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد من حذف المستخدم(ين) التالي(ين)؟</p>
                <ul id="usersToDelete"></ul>
                <div class="alert alert-danger">
                    <strong>تحذير:</strong> لا يمكن التراجع عن هذا الإجراء!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash"></i>
                    حذف نهائياً
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Select All functionality
            $('#selectAll').change(function() {
                $('.user-checkbox:not(:disabled)').prop('checked', this.checked);
                updateDeleteButton();
            });

            // Individual checkbox change
            $('.user-checkbox').change(function() {
                updateDeleteButton();
                
                // Update select all checkbox
                var totalCheckboxes = $('.user-checkbox:not(:disabled)').length;
                var checkedCheckboxes = $('.user-checkbox:checked').length;
                $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
            });

            // Update delete button state
            function updateDeleteButton() {
                var selectedCount = $('.user-checkbox:checked').length;
                $('#selectedCount').text(selectedCount);
                $('#deleteSelectedUsers').prop('disabled', selectedCount === 0);
            }

            // Delete selected users
            $('#deleteSelectedUsers').click(function() {
                var selectedUsers = [];
                $('.user-checkbox:checked').each(function() {
                    var userId = $(this).val();
                    var username = $(this).closest('tr').find('td:nth-child(2)').text();
                    selectedUsers.push({ id: userId, username: username });
                });

                showDeleteModal(selectedUsers);
            });

            // Delete single user
            $('.delete-single-user').click(function() {
                var userId = $(this).data('user-id');
                var username = $(this).data('username');
                showDeleteModal([{ id: userId, username: username }]);
            });

            // Show delete confirmation modal
            function showDeleteModal(users) {
                $('#usersToDelete').empty();
                users.forEach(function(user) {
                    $('#usersToDelete').append('<li><strong>' + user.username + '</strong> (ID: ' + user.id + ')</li>');
                });

                $('#deleteModal').modal('show');

                // Store users to delete
                $('#confirmDelete').data('users', users);
            }

            // Confirm delete
            $('#confirmDelete').click(function() {
                var users = $(this).data('users');
                var userIds = users.map(function(user) { return user.id; });

                // Show loading
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> جاري الحذف...');

                // Send delete request
                $.ajax({
                    url: '/PermissionManager/DeleteUsers',
                    type: 'POST',
                    data: { userIds: userIds },
                    success: function(response) {
                        if (response.success) {
                            // Remove rows from table
                            userIds.forEach(function(userId) {
                                $('tr[data-user-id="' + userId + '"]').fadeOut();
                            });

                            // Show success message
                            showAlert('success', 'تم حذف المستخدمين بنجاح!');
                        } else {
                            showAlert('danger', 'حدث خطأ أثناء الحذف: ' + response.message);
                        }
                    },
                    error: function() {
                        showAlert('danger', 'حدث خطأ في الاتصال بالخادم');
                    },
                    complete: function() {
                        $('#deleteModal').modal('hide');
                        $('#confirmDelete').prop('disabled', false).html('<i class="fas fa-trash"></i> حذف نهائياً');
                    }
                });
            });

            // Show alert function
            function showAlert(type, message) {
                var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                    message +
                    '<button type="button" class="close" data-dismiss="alert">' +
                    '<span>&times;</span>' +
                    '</button>' +
                    '</div>';
                
                $('.card-body').prepend(alertHtml);
                
                // Auto-hide after 5 seconds
                setTimeout(function() {
                    $('.alert').fadeOut();
                }, 5000);
            }
        });
    </script>
}