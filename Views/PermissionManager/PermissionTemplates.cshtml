@model List<WebApplication1.Models.PermissionTemplate>
@{
    ViewData["Title"] = "قوالب الصلاحيات";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-collection"></i>
                        قوالب الصلاحيات
                    </h3>
                    <div class="card-tools">
                        <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i>
                            العودة لإدارة الصلاحيات
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="row">
                        @foreach (var template in Model)
                        {
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-@(template.Id == 1 ? "info" : template.Id == 2 ? "warning" : "danger") text-white">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-@(template.Id == 1 ? "person" : template.Id == 2 ? "person-badge" : "person-check")"></i>
                                            @template.Name
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">@template.Description</p>
                                        
                                        <h6 class="mt-3">صلاحيات القائمة:</h6>
                                        <div class="mb-3">
                                            @foreach (var menuPermission in template.MenuPermissions)
                                            {
                                                <span class="badge bg-@(menuPermission.Value ? "success" : "secondary") me-1 mb-1">
                                                    @GetMenuName(menuPermission.Key)
                                                </span>
                                            }
                                        </div>

                                        <h6>صلاحيات العمليات:</h6>
                                        <div class="mb-3">
                                            @foreach (var operationPermission in template.OperationPermissions)
                                            {
                                                <span class="badge bg-primary me-1 mb-1">
                                                    @GetEntityTypeName(operationPermission.EntityType) - @GetOperationTypeName(operationPermission.OperationType)
                                                </span>
                                            }
                                        </div>

                                        <div class="mt-auto">
                                            <button type="button" class="btn btn-@(template.Id == 1 ? "info" : template.Id == 2 ? "warning" : "danger") btn-sm w-100" 
                                                    onclick="showTemplateDetails(@template.Id)">
                                                <i class="bi bi-eye"></i>
                                                عرض التفاصيل
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Details Modal -->
<div class="modal fade" id="templateDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateDetailsTitle">تفاصيل قالب الصلاحيات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templateDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const templates = @Html.Raw(Json.Serialize(Model));

        function showTemplateDetails(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            $('#templateDetailsTitle').text(`تفاصيل قالب: ${template.name}`);
            
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>وصف القالب:</h6>
                        <p class="text-muted">${template.description}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>معرف القالب:</h6>
                        <span class="badge bg-primary">${template.id}</span>
                    </div>
                </div>
                
                <hr>
                
                <h6>صلاحيات القائمة الجانبية:</h6>
                <div class="row">
            `;
            
            const menuNames = {
                'PROFILE': 'الملف الشخصي',
                'NOTIFICATIONS': 'الإشعارات',
                'DASHBOARD': 'لوحة التحكم',
                'EMPLOYEES': 'الموظفين',
                'CONTROLLERS': 'المراقبين',
                'LICENSES': 'الرخص',
                'CERTIFICATES': 'الشهادات',
                'OBSERVATIONS': 'الملاحظات',
                'CONFIGURATION': 'الإعدادات',
                'PERMISSIONS': 'الصلاحيات'
            };
            
            for (const [menuKey, isVisible] of Object.entries(template.menuPermissions)) {
                const menuName = menuNames[menuKey] || menuKey;
                content += `
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-${isVisible ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>
                            <span>${menuName}</span>
                        </div>
                    </div>
                `;
            }
            
            content += `
                </div>
                
                <hr>
                
                <h6>صلاحيات العمليات:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>النوع</th>
                                <th>العملية</th>
                                <th>النطاق</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const entityNames = {
                'Employee': 'الموظفين',
                'Controller': 'المراقبين',
                'License': 'الرخص',
                'Certificate': 'الشهادات',
                'Observation': 'الملاحظات'
            };
            
            const operationNames = {
                'View': 'عرض',
                'Add': 'إضافة',
                'Edit': 'تعديل',
                'Delete': 'حذف',
                'Export': 'تصدير'
            };
            
            for (const operation of template.operationPermissions) {
                const entityName = entityNames[operation.entityType] || operation.entityType;
                const operationName = operationNames[operation.operationType] || operation.operationType;
                const scopeName = operation.scope === 'All' ? 'الكل' : 
                                 operation.scope === 'Department' ? 'القسم' : 'الخاص';
                
                content += `
                    <tr>
                        <td>${entityName}</td>
                        <td>${operationName}</td>
                        <td>${scopeName}</td>
                        <td>
                            <span class="badge bg-${operation.isAllowed ? 'success' : 'danger'}">
                                ${operation.isAllowed ? 'مسموح' : 'ممنوع'}
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            $('#templateDetailsContent').html(content);
            $('#templateDetailsModal').modal('show');
        }
    </script>
}

@functions {
    string GetMenuName(string menuKey)
    {
        return menuKey switch
        {
            "PROFILE" => "الملف الشخصي",
            "NOTIFICATIONS" => "الإشعارات",
            "DASHBOARD" => "لوحة التحكم",
            "EMPLOYEES" => "الموظفين",
            "CONTROLLERS" => "المراقبين",
            "LICENSES" => "الرخص",
            "CERTIFICATES" => "الشهادات",
            "OBSERVATIONS" => "الملاحظات",
            "CONFIGURATION" => "الإعدادات",
            "PERMISSIONS" => "الصلاحيات",
            _ => menuKey
        };
    }

    string GetEntityTypeName(string entityType)
    {
        return entityType switch
        {
            "Employee" => "الموظفين",
            "Controller" => "المراقبين",
            "License" => "الرخص",
            "Certificate" => "الشهادات",
            "Observation" => "الملاحظات",
            _ => entityType
        };
    }

    string GetOperationTypeName(string operationType)
    {
        return operationType switch
        {
            "View" => "عرض",
            "Add" => "إضافة",
            "Edit" => "تعديل",
            "Delete" => "حذف",
            "Export" => "تصدير",
            _ => operationType
        };
    }
}