@model WebApplication1.Services.UserPermissionDetails
@{
    ViewData["Title"] = $"Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - {Model.FullName}";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-person-gear"></i>
                            Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… : @Model.FullName
                        </h4>
                        <div class="d-flex">
                            <button type="button" class="btn btn-warning btn-sm me-2" onclick="clearUserCacheDynamically(@Model.UserId)" title="Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ">
                                <i class="bi bi-arrow-clockwise"></i>
                                Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
                                <i class="bi bi-arrow-left"></i>
                                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- User Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h5>
                                    <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> @Model.Username</p>
                                    <p><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> @Model.FullName</p>
                                    <p><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> 
                                        <span class="badge bg-@(Model.RoleName == "Admin" ? "danger" : Model.RoleName == "Manager" ? "warning" : "info")">
                                            @Model.RoleName
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h5>
                                    @{
                                        var activeMenuPermissions = Model.MenuPermissions.Count(p => p.IsVisible);
                                        var totalMenuPermissions = Model.MenuPermissions.Count;
                                        var activeOperationPermissions = Model.OperationPermissions.Count(p => p.IsAllowed);
                                        var totalOperationPermissions = Model.OperationPermissions.Count;

                                    }
                                    <p><strong>ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</strong> 
                                        <span class="badge bg-@(activeMenuPermissions > 0 ? "success" : "secondary")">
                                            @activeMenuPermissions Ù…Ù† @totalMenuPermissions
                                        </span>
                                        @if (activeMenuPermissions > 0)
                                        {
                                            <small class="text-muted">(Ù…ÙØ¹Ù„Ø©)</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">(ØºÙŠØ± Ù…ÙØ¹Ù„Ø©)</small>
                                        }
                                    </p>
                                    <p><strong>ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</strong> 
                                        <span class="badge bg-@(activeOperationPermissions > 0 ? "success" : "secondary")">
                                            @activeOperationPermissions Ù…Ù† @totalOperationPermissions
                                        </span>
                                        @if (activeOperationPermissions > 0)
                                        {
                                            <small class="text-muted">(Ù…ÙØ¹Ù„Ø©)</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">(ØºÙŠØ± Ù…ÙØ¹Ù„Ø©)</small>
                                        }
                                    </p>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="clearUserCacheDynamically(@Model.UserId)" title="Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ - ØªØ­Ø¯ÙŠØ« timestamps ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©">
                                    <i class="bi bi-lightning"></i>
                                    Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="debugUserPermissions(@Model.UserId)" title="ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                    <i class="bi bi-bug"></i>
                                    ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="permissionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu" type="button" role="tab">
                                <i class="bi bi-list"></i>
                                ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations" type="button" role="tab">
                                <i class="bi bi-gear"></i>
                                ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                            </button>
                        </li>

                    </ul>

                    <div class="tab-content" id="permissionTabsContent">
                        <!-- Menu Permissions Tab -->
                        <div class="tab-pane fade show active" id="menu" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-list"></i>
                                        ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                                    </h5>
                                    <div class="mt-2">
                                        @{
                                            var activeMenus = Model.MenuPermissions.Count(p => p.IsVisible);
                                            var totalMenus = Model.MenuPermissions.Count;
                                        }
                                        <span class="badge bg-info me-2">
                                            <i class="bi bi-info-circle"></i>
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: @totalMenus
                                        </span>
                                        <span class="badge bg-@(activeMenus > 0 ? "success" : "warning") me-2">
                                            <i class="bi bi-check-circle"></i>
                                            Ù…ÙØ¹Ù„Ø©: @activeMenus
                                        </span>
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle"></i>
                                            ØºÙŠØ± Ù…ÙØ¹Ù„Ø©: @(totalMenus - activeMenus)
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        @{
                                            var menuItems = new Dictionary<string, string>
                                            {
                                                { "PROFILE", "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" },
                                                { "NOTIFICATIONS", "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" },
                                                { "DASHBOARD", "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" },
                                                { "EMPLOYEES", "Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†" },
                                                { "CONTROLLERS", "Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†" },
                                                { "LICENSES", "Ø§Ù„Ø±Ø®Øµ" },
                                                { "CERTIFICATES", "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª" },
                                                { "OBSERVATIONS", "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" },
                                                { "CONFIGURATION", "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" },
                                                { "PERMISSIONS", "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" },
                                                { "ORGANIZATION_VIEW", "Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ" },
                                                { "PROJECT_VIEW", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±" }
                                            };
                                        }
                                        
                                        @foreach (var menuItem in menuItems)
                                        {
                                            var isVisible = Model.MenuPermissions.FirstOrDefault(m => m.MenuKey == menuItem.Key)?.IsVisible ?? false;
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card @(isVisible ? "border-success" : "border-secondary") h-100">
                                                    <div class="card-body p-3">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input menu-permission" 
                                                                   type="checkbox" 
                                                                   id="menu_@menuItem.Key" 
                                                                   data-menu-key="@menuItem.Key"
                                                                   @(isVisible ? "checked" : "")>
                                                            <label class="form-check-label d-flex align-items-center" for="menu_@menuItem.Key">
                                                                @if (isVisible)
                                                                {
                                                                    <i class="bi bi-check-circle-fill text-success me-2" title="ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙØ¹Ù„Ø©"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-x-circle text-muted me-2" title="ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©"></i>
                                                                }
                                                                <span class="fw-bold">@menuItem.Value</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-primary" onclick="saveMenuPermissions()">
                                            <i class="bi bi-save"></i>
                                            Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Operations Permissions Tab -->
                        <div class="tab-pane fade" id="operations" role="tabpanel">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-gear"></i>
                                        ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                                    </h5>
                                    <div class="mt-2">
                                        @{
                                            var activeOps = Model.OperationPermissions.Count(p => p.IsAllowed);
                                            var totalOps = Model.OperationPermissions.Count;
                                        }
                                        <span class="badge bg-info me-2">
                                            <i class="bi bi-info-circle"></i>
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: @totalOps
                                        </span>
                                        <span class="badge bg-@(activeOps > 0 ? "success" : "warning") me-2">
                                            <i class="bi bi-check-circle"></i>
                                            Ù…ÙØ¹Ù„Ø©: @activeOps
                                        </span>
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle"></i>
                                            ØºÙŠØ± Ù…ÙØ¹Ù„Ø©: @(totalOps - activeOps)
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (55 ØµÙ„Ø§Ø­ÙŠØ©). Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ ØªÙ…Ø«Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©ØŒ ÙˆØ§Ù„ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ØªÙ…Ø«Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± Ø§Ù„Ù…ÙØ¹Ù„Ø©.
                                    </div>
                                    
                                    <!-- Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
                                    <div class="alert alert-light border">
                                        <h6 class="mb-2"><i class="bi bi-palette-fill"></i> Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small>
                                                    <i class="bi bi-people-fill text-primary me-1"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†<br>
                                                    <i class="bi bi-person-badge-fill text-info me-1"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†<br>
                                                    <i class="bi bi-award-fill text-warning me-1"></i> Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†<br>
                                                    <i class="bi bi-mortarboard-fill text-success me-1"></i> Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <small>
                                                    <i class="bi bi-eye-fill text-secondary me-1"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª<br>
                                                    <i class="bi bi-file-earmark-check-fill text-danger me-1"></i> Ø±Ø®Øµ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†<br>
                                                    <i class="bi bi-file-earmark-text-fill text-dark me-1"></i> Ø±Ø®Øµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th width="25%">Ø§Ù„Ù†ÙˆØ¹</th>
                                                    <th width="20%">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                                    <th width="20%">Ø§Ù„Ù†Ø·Ø§Ù‚</th>
                                                    <th width="35%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    var entityTypes = new[] { "Employee", "Controller", "ControllerCertificate", "EmployeeCertificate", "ControllerObservation", "EmployeeObservation", "ControllerLicense", "EmployeeLicense", "Project", "Country", "Airport", "DepartmentOverview" };
                                                    var operationTypes = new[] { "View", "Add", "Edit", "Delete", "Export" };
                                                }
                                                
                                                @foreach (var entityType in entityTypes)
                                                {
                                                    @foreach (var operationType in operationTypes)
                                                    {
                                                        var permission = Model.OperationPermissions.FirstOrDefault(p => 
                                                            p.EntityType == entityType && p.OperationType == operationType);
                                                        var isAllowed = permission?.IsAllowed ?? false;
                                                        var scope = permission?.Scope ?? "All";
                                                        
                                                        <tr class="@(isAllowed ? "table-success" : "")">
                                                            <td>
                                                                <strong class="@GetEntityTypeColor(entityType)">
                                                                    <i class="@GetEntityTypeIcon(entityType) me-1"></i>
                                                                    @GetEntityTypeName(entityType)
                                                                </strong>
                                                                @if (isAllowed)
                                                                {
                                                                    <i class="bi bi-check-circle-fill text-success ms-1" title="ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙØ¹Ù„Ø©"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-x-circle text-muted ms-1" title="ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©"></i>
                                                                }
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-@(isAllowed ? "success" : "secondary")">
                                                                    @GetOperationTypeName(operationType)
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <select class="form-select form-select-sm operation-scope" 
                                                                        data-entity-type="@entityType" 
                                                                        data-operation-type="@operationType">
                                                                    <option value="All" selected="@(scope == "All")">Ø§Ù„ÙƒÙ„</option>
                                                                    <option value="Department" selected="@(scope == "Department")">Ø§Ù„Ù‚Ø³Ù…</option>
                                                                    <option value="Own" selected="@(scope == "Own")">Ø§Ù„Ø®Ø§Øµ</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="form-check form-switch me-3">
                                                                        <input class="form-check-input operation-permission" 
                                                                               type="checkbox" 
                                                                               data-entity-type="@entityType" 
                                                                               data-operation-type="@operationType"
                                                                               @(isAllowed ? "checked" : "")>
                                                                    </div>
                                                                    <div class="flex-grow-1">
                                                                        @if (isAllowed)
                                                                        {
                                                                            <span class="badge bg-success fs-6">
                                                                                <i class="bi bi-check-circle-fill me-1"></i>
                                                                                Ù…ÙØ¹Ù„
                                                                            </span>
                                                                        }
                                                                        else
                                                                        {
                                                                            <span class="badge bg-secondary fs-6">
                                                                                <i class="bi bi-x-circle me-1"></i>
                                                                                ØºÙŠØ± Ù…ÙØ¹Ù„
                                                                            </span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-primary" onclick="saveOperationPermissions()">
                                            <i class="bi bi-save"></i>
                                            Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const userId = @Model.UserId;

        function saveMenuPermissions() {
            const menuPermissions = {};
            $('.menu-permission').each(function() {
                const menuKey = $(this).data('menu-key');
                const isVisible = $(this).is(':checked');
                menuPermissions[menuKey] = isVisible;
            });

            // Show loading indicator
            const saveButton = $('button[onclick="saveMenuPermissions()"]');
            const originalText = saveButton.html();
            saveButton.html('<i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...').prop('disabled', true);

            $.ajax({
                url: '@Url.Action("UpdateMenuPermissions")',
                type: 'POST',
                data: {
                    userId: userId,
                    menuPermissions: menuPermissions
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        // Reload the page after successful save to reflect changes
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('error', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving menu permissions:', error);
                    showAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ' + error);
                },
                complete: function() {
                    // Restore button state
                    saveButton.html(originalText).prop('disabled', false);
                }
            });
        }

        function saveOperationPermissions() {
            const operationPermissions = [];
            
            console.log('=== DEBUGGING OPERATION PERMISSIONS ===');
            console.log('Total .operation-permission elements found:', $('.operation-permission').length);
            
            $('.operation-permission').each(function(index) {
                const entityType = $(this).data('entity-type');
                const operationType = $(this).data('operation-type');
                const isAllowed = $(this).is(':checked');
                const scope = $(this).closest('tr').find('.operation-scope').val();
                
                console.log(`Operation Element ${index + 1}:`, {
                    entityType,
                    operationType,
                    isAllowed,
                    scope,
                    element: this
                });
                
                operationPermissions.push({
                    EntityType: entityType,
                    OperationType: operationType,
                    IsAllowed: isAllowed,
                    Scope: scope,
                    ScopeId: null
                });
            });

            console.log('Sending operation permissions:', {
                userId: userId,
                operationPermissions: operationPermissions
            });

            // Show loading indicator
            const saveButton = $('button[onclick="saveOperationPermissions()"]');
            const originalText = saveButton.html();
            saveButton.html('<i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...').prop('disabled', true);

            $.ajax({
                url: '@Url.Action("UpdateOperationPermissions")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    userId: userId,
                    operationPermissions: operationPermissions
                }),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        // Reload the page after successful save to reflect changes
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('error', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving operation permissions:', error);
                    showAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ' + error);
                },
                complete: function() {
                    // Restore button state
                    saveButton.html(originalText).prop('disabled', false);
                }
            });
        }



        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="${icon}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('.card-body').prepend(alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}

@functions {
    string GetEntityTypeName(string entityType)
    {
        return entityType switch
        {
            "Employee" => "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            "Controller" => "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†",
            "ControllerCertificate" => "Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†",
            "EmployeeCertificate" => "Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            "ControllerObservation" => "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†",
            "EmployeeObservation" => "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            "ControllerLicense" => "Ø±Ø®Øµ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†",
            "EmployeeLicense" => "Ø±Ø®Øµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            "Project" => "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±",
            "Country" => "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆÙ„",
            "Airport" => "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø±Ø§Øª",
            "DepartmentOverview" => "Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…",
            _ => entityType
        };
    }

    string GetEntityTypeColor(string entityType)
    {
        return entityType switch
        {
            "Employee" => "text-primary",
            "Controller" => "text-info",
            "ControllerCertificate" => "text-warning",
            "EmployeeCertificate" => "text-success",
            "ControllerObservation" => "text-info",
            "EmployeeObservation" => "text-primary",
            "ControllerLicense" => "text-danger",
            "EmployeeLicense" => "text-dark",
            "Project" => "text-success",
            "Country" => "text-warning",
            "Airport" => "text-info",
            "DepartmentOverview" => "text-primary",
            _ => "text-muted"
        };
    }

    string GetEntityTypeIcon(string entityType)
    {
        return entityType switch
        {
            "Employee" => "bi bi-people-fill",
            "Controller" => "bi bi-person-badge-fill",
            "ControllerCertificate" => "bi bi-award-fill",
            "EmployeeCertificate" => "bi bi-mortarboard-fill",
            "ControllerObservation" => "bi bi-eye-fill",
            "EmployeeObservation" => "bi bi-eye-fill",
            "ControllerLicense" => "bi bi-file-earmark-check-fill",
            "EmployeeLicense" => "bi bi-file-earmark-text-fill",
            "Project" => "bi bi-calendar-event-fill",
            "Country" => "bi bi-globe",
            "Airport" => "bi bi-airplane",
            "DepartmentOverview" => "bi bi-people-fill",
            _ => "bi bi-gear-fill"
        };
    }

    string GetOperationTypeName(string operationType)
    {
        return operationType switch
        {
            "View" => "Ø¹Ø±Ø¶",
            "Add" => "Ø¥Ø¶Ø§ÙØ©",
            "Edit" => "ØªØ¹Ø¯ÙŠÙ„",
            "Delete" => "Ø­Ø°Ù",
            "Export" => "ØªØµØ¯ÙŠØ±",
            _ => operationType
        };
    }


}

<script>
function clearUserCacheDynamically(userId) {
    if (confirm('ğŸ”¥ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØŸ Ù‡Ø°Ø§ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« timestamps ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.')) {
        $.ajax({
            url: '@Url.Action("ClearUserCacheDynamically")',
            type: 'POST',
            data: { userId: userId },
            success: function(response) {
                if (response.success) {
                    alert('ğŸ”¥ ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ù†Ø¬Ø§Ø­!\n\nØªÙ… ØªØ­Ø¯ÙŠØ« timestamps ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.');
                    location.reload();
                } else {
                    alert('Ø®Ø·Ø£: ' + response.message);
                }
            },
            error: function() {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ');
            }
        });
    }
}

function debugUserPermissions(userId) {
    $.ajax({
        url: '@Url.Action("DebugUserMenuPermissions")',
        type: 'GET',
        data: { userId: userId },
        success: function(response) {
            if (response.success) {
                var data = response.data;
                var message = 'ØªØ­Ù„ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + data.UserName + '\n\n';
                message += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ' + data.TotalMenuPermissions + '\n';
                message += 'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©: ' + data.VisibleMenuPermissions + '\n\n';
                message += 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:\n';
                
                data.MenuPermissions.forEach(function(perm) {
                    message += 'â€¢ ' + perm.MenuName + ' (' + perm.MenuKey + '): ' + (perm.IsVisible ? 'Ù…ÙØ¹Ù„ âœ“' : 'ØºÙŠØ± Ù…ÙØ¹Ù„ âœ—') + '\n';
                });
                
                alert(message);
            } else {
                alert('Ø®Ø·Ø£: ' + response.message);
            }
        },
        error: function() {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
        }
    });
}
</script>