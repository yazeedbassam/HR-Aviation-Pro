@model System.Data.DataTable
@using System.Data
@{
    ViewData["Title"] = "سجلات النظام";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt"></i>
                        سجلات أنشطة المستخدمين
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">@ViewBag.TotalCount سجل</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <form method="get" class="form-inline">
                                <div class="form-group mx-2">
                                    <label class="mr-2">الإجراء:</label>
                                    <select name="action" class="form-control form-control-sm">
                                        <option value="">الكل</option>
                                        @if (ViewBag.Actions != null && ViewBag.Actions.Rows.Count > 0)
                                        {
                                            foreach (DataRow row in ViewBag.Actions.Rows)
                                            {
                                                var action = row["Action"]?.ToString() ?? "";
                                                <option value="@action" selected="@(action == ViewBag.Filters?.Action)">@action</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="form-group mx-2">
                                    <label class="mr-2">نوع الكيان:</label>
                                    <select name="entityType" class="form-control form-control-sm">
                                        <option value="">الكل</option>
                                        @if (ViewBag.EntityTypes != null && ViewBag.EntityTypes.Rows.Count > 0)
                                        {
                                            foreach (DataRow row in ViewBag.EntityTypes.Rows)
                                            {
                                                var entityType = row["EntityType"]?.ToString() ?? "";
                                                <option value="@entityType" selected="@(entityType == ViewBag.Filters?.EntityType)">@entityType</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="form-group mx-2">
                                    <label class="mr-2">اسم المستخدم:</label>
                                    <input type="text" name="userName" value="@(ViewBag.Filters?.UserName ?? "")" class="form-control form-control-sm" placeholder="اسم المستخدم">
                                </div>
                                <div class="form-group mx-2">
                                    <label class="mr-2">من تاريخ:</label>
                                    <input type="date" name="startDate" value="@(ViewBag.Filters?.StartDate ?? "")" class="form-control form-control-sm">
                                </div>
                                <div class="form-group mx-2">
                                    <label class="mr-2">إلى تاريخ:</label>
                                    <input type="date" name="endDate" value="@(ViewBag.Filters?.EndDate ?? "")" class="form-control form-control-sm">
                                </div>
                                <div class="form-group mx-2">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search"></i>
                                        بحث
                                    </button>
                                    <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-times"></i>
                                        مسح
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <form method="post" action="@Url.Action("ExportLogs")" class="d-inline">
                                <input type="hidden" name="action" value="@(ViewBag.Filters?.Action ?? "")">
                                <input type="hidden" name="entityType" value="@(ViewBag.Filters?.EntityType ?? "")">
                                <input type="hidden" name="userName" value="@(ViewBag.Filters?.UserName ?? "")">
                                <input type="hidden" name="startDate" value="@(ViewBag.Filters?.StartDate ?? "")">
                                <input type="hidden" name="endDate" value="@(ViewBag.Filters?.EndDate ?? "")">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="fas fa-download"></i>
                                    تصدير CSV
                                </button>
                            </form>
                            <form method="post" action="@Url.Action("ClearOldLogs")" class="d-inline ml-2" onsubmit="return confirm('هل أنت متأكد من حذف السجلات القديمة؟')">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="fas fa-trash"></i>
                                    تنظيف السجلات القديمة (90 يوم)
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>المستخدم</th>
                                    <th>الإجراء</th>
                                    <th>نوع الكيان</th>
                                    <th>معرف الكيان</th>
                                    <th>التفاصيل</th>
                                    <th>عنوان IP</th>
                                    <th>التاريخ والوقت</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Rows.Count > 0)
                                {
                                    int rowNumber = 1;
                                    foreach (DataRow row in Model.Rows)
                                    {
                                        var isSuccessful = Convert.ToBoolean(row["IsSuccessful"]);
                                        var action = row["Action"].ToString();
                                        var entityType = row["EntityType"].ToString();
                                        var details = row["Details"]?.ToString() ?? "";
                                        var ipAddress = row["IpAddress"]?.ToString() ?? "";
                                        var timestamp = Convert.ToDateTime(row["Timestamp"]);
                                        var errorMessage = row["ErrorMessage"]?.ToString();

                                        <tr class="@(isSuccessful ? "" : "table-danger")">
                                            <td>@rowNumber</td>
                                            <td>
                                                <strong>@row["UserName"]</strong>
                                                <br>
                                                <small class="text-muted">ID: @row["UserId"]</small>
                                            </td>
                                            <td>
                                                <span class="badge badge-@(GetActionBadgeClass(action))">
                                                    @GetActionArabicName(action)
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">
                                                    @GetEntityTypeArabicName(entityType)
                                                </span>
                                            </td>
                                            <td>@(row["EntityId"]?.ToString() ?? "-")</td>
                                            <td>
                                                @details
                                                @if (!string.IsNullOrEmpty(errorMessage))
                                                {
                                                    <br>
                                                    <small class="text-danger">
                                                        <strong>خطأ:</strong> @errorMessage
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                <code>@ipAddress</code>
                                            </td>
                                            <td>
                                                @timestamp.ToString("yyyy/MM/dd HH:mm:ss")
                                                <br>
                                                <small class="text-muted">@timestamp.ToString("dddd", new System.Globalization.CultureInfo("ar-SA"))</small>
                                            </td>
                                            <td>
                                                @if (isSuccessful)
                                                {
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check"></i>
                                                        نجح
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-danger">
                                                        <i class="fas fa-times"></i>
                                                        فشل
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                        rowNumber++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            لا توجد سجلات لعرضها
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    @if (ViewBag.TotalPages > 1)
                    {
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                @if (ViewBag.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage - 1, pageSize = ViewBag.PageSize, action = ViewBag.Filters?.Action, entityType = ViewBag.Filters?.EntityType, userName = ViewBag.Filters?.UserName, startDate = ViewBag.Filters?.StartDate, endDate = ViewBag.Filters?.EndDate })">
                                            <i class="fas fa-chevron-right"></i>
                                            السابق
                                        </a>
                                    </li>
                                }

                                @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                                                                 <a class="page-link" href="@Url.Action("Index", new { page = i, pageSize = ViewBag.PageSize, action = ViewBag.Filters?.Action, entityType = ViewBag.Filters?.EntityType, userName = ViewBag.Filters?.UserName, startDate = ViewBag.Filters?.StartDate, endDate = ViewBag.Filters?.EndDate })">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                {
                                    <li class="page-item">
                                                                                 <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage + 1, pageSize = ViewBag.PageSize, action = ViewBag.Filters?.Action, entityType = ViewBag.Filters?.EntityType, userName = ViewBag.Filters?.UserName, startDate = ViewBag.Filters?.StartDate, endDate = ViewBag.Filters?.EndDate })">
                                            التالي
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetActionBadgeClass(string action)
    {
        return action switch
        {
            "Create" => "success",
            "Update" => "primary",
            "Delete" => "danger",
            "Login" => "info",
            "Logout" => "secondary",
            "View" => "info",
            "Export" => "warning",
            "Import" => "warning",
            _ => "secondary"
        };
    }

    private string GetActionArabicName(string action)
    {
        return action switch
        {
            "Create" => "إنشاء",
            "Update" => "تحديث",
            "Delete" => "حذف",
            "Login" => "تسجيل دخول",
            "Logout" => "تسجيل خروج",
            "View" => "عرض",
            "Export" => "تصدير",
            "Import" => "استيراد",
            _ => action
        };
    }

    private string GetEntityTypeArabicName(string entityType)
    {
        return entityType switch
        {
            "Employee" => "موظف",
            "Controller" => "مراقب",
            "License" => "رخصة",
            "Certificate" => "شهادة",
            "Observation" => "ملاحظة",
            "Project" => "مشروع",
            "Airport" => "مطار",
            "Country" => "دولة",
            "System" => "النظام",
            "Profile" => "الملف الشخصي",
            "SystemLog" => "سجل النظام",
            _ => entityType
        };
    }
} 