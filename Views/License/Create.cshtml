@model WebApplication1.Models.License

@{
    var pageTitle = ViewBag.ActiveTab == "controllers" ? "Add New Controller License" : "Add New Employee License";
    ViewData["Title"] = pageTitle;
}

<style>
    .custom-card {
        margin-top: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .custom-header {
        font-size: 1.15rem;
        font-weight: 600;
        letter-spacing: .5px;
        color: #198754;
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #f8f9fa;
    }

    .form-section-header {
        font-size: 1rem;
        font-weight: 600;
        color: #343a40;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }

    .form-control-sm, .form-select-sm {
        font-size: 0.85rem;
    }

    .col-form-label-sm {
        font-weight: 500;
    }

    .btn-group-custom {
        display: flex;
        gap: 10px;
    }
    /* Style to hide the proficiency level initially */
    #proficiencyLevelDiv {
        display: none;
    }

    #expiry-message {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 5px;
    }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="card custom-card">
            <div class="card-header custom-header">
                <i class="fa-solid fa-plus-circle"></i>
                @pageTitle
            </div>
            <div class="card-body p-4">
                <form id="createLicenseForm" asp-action="Create" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    @if (ViewBag.ActiveTab == "controllers")
                    {
                        <div class="alert alert-info mb-3">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Controller License:</strong> You are adding a license for an Air Traffic Controller. The Employee selection has been hidden for clarity.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-3">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Employee License:</strong> You are adding a license for an Employee or Operation Staff member. The Controller selection has been hidden for clarity.
                        </div>
                    }

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <h5 class="form-section-header">Select Person</h5>
                                                         <div class="row mb-3 align-items-center" id="controller-section" style="display: @(ViewBag.ActiveTab == "employees" ? "none" : "flex");">
                                 <label asp-for="ControllerId" class="col-md-4 col-form-label col-form-label-sm">Controller</label>
                                 <div class="col-md-8">
                                     <select asp-for="ControllerId" asp-items="@(new SelectList(ViewBag.Controllers, "Value", "Text"))" class="form-select form-select-sm" id="controller-select">
                                         <option value="">-- Select ATC --</option>
                                     </select>
                                 </div>
                             </div>
                            <div class="row mb-3 align-items-center" id="employee-section" style="display: @(ViewBag.ActiveTab == "controllers" ? "none" : "flex");">
                                <label asp-for="EmployeeId" class="col-md-4 col-form-label col-form-label-sm">Employee</label>
                                <div class="col-md-8">
                                    <select asp-for="EmployeeId" asp-items="@(new SelectList(ViewBag.Employees, "Value", "Text"))" class="form-select form-select-sm" id="employee-select">
                                        <option value="">-- Select Employee --</option>
                                    </select>
                                </div>
                            </div>

                            <h5 class="form-section-header">License Details</h5>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="LicenseType" class="col-md-4 col-form-label col-form-label-sm">License Type</label>
                                <div class="col-md-8">
                                    <select asp-for="LicenseType" asp-items="ViewBag.LicenseTypes" class="form-select form-select-sm" id="LicenseType">
                                        <option value="">-- Select Type --</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Proficiency Level - Initially hidden -->
                            <div class="row mb-3 align-items-center" id="proficiencyLevelDiv">
                                <label asp-for="RANGE" class="col-md-4 col-form-label col-form-label-sm">Proficiency Level</label>
                                <div class="col-md-8">
                                    <select asp-for="RANGE" class="form-select form-select-sm" id="RANGE">
                                        <option value="">-- Select Level --</option>
                                        <option value="4">Level 4</option>
                                        <option value="5">Level 5</option>
                                        <option value="6">Level 6</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="licensenumber" class="col-md-4 col-form-label col-form-label-sm">License No.</label>
                                <div class="col-md-8">
                                    <input asp-for="licensenumber" class="form-control form-control-sm" />
                                </div>
                            </div>

                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <h5 class="form-section-header">Dates & File</h5>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="IssueDate" class="col-md-4 col-form-label col-form-label-sm"></label>
                                <div class="col-md-8">
                                    <input asp-for="IssueDate" type="date" class="form-control form-control-sm" id="IssueDate" />
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="ExpiryDate" class="col-md-4 col-form-label col-form-label-sm"></label>
                                <div class="col-md-8">
                                    <input asp-for="ExpiryDate" type="date" class="form-control form-control-sm" id="ExpiryDate" />
                                    <div id="expiry-message"></div>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="LicenseFile" class="col-md-4 col-form-label col-form-label-sm">PDF File</label>
                                <div class="col-md-8">
                                    <input asp-for="LicenseFile" class="form-control form-control-sm" type="file" />
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <label asp-for="Note" class="col-md-4 col-form-label col-form-label-sm"></label>
                                <div class="col-md-8">
                                    <textarea asp-for="Note" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 border-top pt-3 btn-group-custom">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle me-2"></i>Create License</button>
                        <button type="reset" class="btn btn-warning"><i class="fas fa-undo me-2"></i>Reset Form</button>
                        <a asp-action="Index" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Back to List</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const controllerSelect = document.getElementById('controller-select');
            const employeeSelect = document.getElementById('employee-select');
            const licenseTypeSelect = document.getElementById('LicenseType');
            const proficiencyLevelDiv = document.getElementById('proficiencyLevelDiv');
            const proficiencyLevelSelect = document.getElementById('RANGE');
            const issueDateInput = document.getElementById('IssueDate');
            const expiryDateInput = document.getElementById('ExpiryDate');
            const expiryMessage = document.getElementById('expiry-message');

            function handleLicenseLogic() {
                const licenseType = licenseTypeSelect.value;
                const proficiencyLevel = proficiencyLevelSelect.value;
                const issueDate = issueDateInput.value;

                // Debug: Log the selected license type
                console.log('Selected License Type:', licenseType);
                console.log('Selected License Type Text:', licenseTypeSelect.options[licenseTypeSelect.selectedIndex]?.text);

                // Check for English Proficiency Test using Text
                if (licenseType === 'English Proficiency Test') {
                    proficiencyLevelDiv.style.display = 'flex'; // Use flex to align with other rows

                    if (proficiencyLevel === '6') {
                        expiryDateInput.readOnly = true;
                        expiryDateInput.value = '';
                        expiryMessage.textContent = 'Proficiency Level 6 is a lifetime license.';
                    } else if (issueDate && (proficiencyLevel === '4' || proficiencyLevel === '5')) {
                        const yearsToAdd = (proficiencyLevel === '4') ? 3 : 6;
                        const newExpiryDate = new Date(issueDate);
                        newExpiryDate.setFullYear(newExpiryDate.getFullYear() + yearsToAdd);

                        // Format to YYYY-MM-DD for the input field
                        expiryDateInput.value = newExpiryDate.toISOString().split('T')[0];
                        expiryDateInput.readOnly = true;
                        expiryMessage.textContent = '';
                    } else {
                        expiryDateInput.readOnly = false;
                        expiryMessage.textContent = '';
                    }
                } else {
                    proficiencyLevelDiv.style.display = 'none';
                    proficiencyLevelSelect.value = ''; // Reset level if type changes
                    expiryDateInput.readOnly = false;
                    expiryMessage.textContent = '';
                }
            }

            // Event listeners
            licenseTypeSelect.addEventListener('change', handleLicenseLogic);
            proficiencyLevelSelect.addEventListener('change', handleLicenseLogic);
            issueDateInput.addEventListener('change', handleLicenseLogic);

            // Logic for disabling controller/employee dropdowns
            controllerSelect.addEventListener('change', function() {
                if (this.value) {
                    employeeSelect.value = '';
                    employeeSelect.disabled = true;
                } else {
                    employeeSelect.disabled = false;
                }
            });

            employeeSelect.addEventListener('change', function() {
                if (this.value) {
                    controllerSelect.value = '';
                    controllerSelect.disabled = true;
                } else {
                    controllerSelect.disabled = false;
                }
            });

                         // Auto-select based on active tab
             const activeTab = '@ViewBag.ActiveTab';
             if (activeTab === 'controllers') {
                 employeeSelect.disabled = true;
                 employeeSelect.value = '';
                 controllerSelect.disabled = false;
             } else if (activeTab === 'employees') {
                 controllerSelect.disabled = true;
                 controllerSelect.value = '';
                 employeeSelect.disabled = false;
             }

            // Initial call to set the state on page load
            handleLicenseLogic();
        });
    </script>
}
