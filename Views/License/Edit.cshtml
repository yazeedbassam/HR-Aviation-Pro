@model WebApplication1.Models.License

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
    .custom-card {
        max-width: 650px;
        margin: 18px auto;
        border-radius: 11px;
        box-shadow: 0 2px 9px rgba(0,0,0,0.05 );
        font-size: 0.91rem;
        padding-bottom: 8px;
    }

    .section-title {
        font-size: 1.00rem;
        font-weight: 600;
        color: #14562a;
        margin: 15px 0 5px 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(to right, #188844 50%, #eee 100%);
        border-radius: 1.5px;
        margin: 0 0 7px 0;
        opacity: 0.16;
    }

    .form-label {
        font-weight: 500;
        font-size: 0.95em;
        margin-bottom: 2px;
    }

    .form-group {
        margin-bottom: 7px;
    }

    .form-control,
    .form-select {
        border-radius: 7px;
        min-height: 28px;
        font-size: 0.95em;
        padding: 3px 8px;
    }

    textarea.form-control {
        min-height: 45px;
    }

    .alert-danger {
        font-size: 0.91rem;
        margin-top: 8px;
        margin-bottom: 7px;
        padding: 6px 12px;
    }

    .btn,
    .btn-success,
    .btn-secondary,
    .btn-primary {
        font-size: 0.97em;
        border-radius: 7px;
        padding: 4px 18px 4px 16px;
    }

    .col-12.text-end.mt-3 {
        margin-top: 10px !important;
    }
</style>


<div class="card custom-card">
    <div class="card-header bg-primary text-white d-flex align-items-center" style="border-radius:15px 15px 0 0;">
        <i class="fa-solid fa-pen-to-square fa-lg me-2"></i>
        <span>Edit License / Permission</span>
    </div>
    <div class="card-body">
        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
        {
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@err.ErrorMessage</li>
                    }
                </ul>
            </div>
        }

        <form asp-action="Edit" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            @* قيم مخفية *@
            <input type="hidden" asp-for="LicenseId" />
            <input type="hidden" asp-for="ControllerId" />
            <input type="hidden" asp-for="EmployeeId" /> @* هذا الحقل مهم لـ EmployeeId *@
            <input type="hidden" asp-for="LicenseType" id="LicenseType" />

            @if (Model.ControllerId.HasValue)
            {
                <!-- SECTION 1: Controller & License Info -->
                <div class="section-title mt-2">
                    <i class="fa-solid fa-user"></i> Controller & License Info
                </div>
                <div class="section-divider"></div>
                <div class="row g-3">
                    <div class="col-md-6 form-group">
                        <label class="form-label">Full Name</label>
                        <input class="form-control" value="@Model.ControllerName" readonly />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">Airport</label>
                        <input class="form-control" value="@Model.AirportName" readonly />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">License Type</label>
                        <input class="form-control" value="@Model.LicenseType" readonly />
                    </div>
                    <div class="col-md-6 form-group" id="proficiencyLevelDiv" style="display:none;">
                        <label for="RANGE" class="form-label">English Proficiency Level</label>
                        <select asp-for="RANGE" id="RANGE" class="form-select">
                            <option value="">-- Select Level --</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                        </select>
                        <span asp-validation-for="RANGE" class="text-danger small"></span>
                    </div>
                </div>
            }
            else if (Model.EmployeeId.HasValue)
            {
                <!-- SECTION 1: Employee & License Info -->
                <div class="section-title mt-2">
                    <i class="fa-solid fa-user"></i> Employee & License Info
                </div>
                <div class="section-divider"></div>
                <div class="row g-3">
                    <div class="col-md-6 form-group">
                        <label class="form-label">Full Name</label>
                        <input class="form-control" value="@Model.EmployeeName" readonly />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">Department</label>
                        <input class="form-control" value="@Model.EmployeeDepartment" readonly />
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="form-label">License Type</label>
                        <input class="form-control" value="@Model.LicenseType" readonly />
                    </div>
                    <div class="col-md-6 form-group" id="proficiencyLevelDiv" style="display:none;">
                        <label for="RANGE" class="form-label">English Proficiency Level</label>
                        <select asp-for="RANGE" id="RANGE" class="form-select">
                            <option value="">-- Select Level --</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                        </select>
                        <span asp-validation-for="RANGE" class="text-danger small"></span>
                    </div>
                </div>
            }

            <!-- SECTION 2: Dates & Notes -->
            <div class="section-title">
                <i class="fa-solid fa-calendar-days"></i> License Dates & Notes
            </div>
            <div class="section-divider"></div>
            <div class="row g-3">
                <div class="col-md-6 form-group">
                    <label asp-for="IssueDate" class="form-label">Issue Date</label>
                    <input type="date" asp-for="IssueDate" class="form-control" required value="@(Model.IssueDate?.ToString("yyyy-MM-dd"))" />
                    <span asp-validation-for="IssueDate" class="text-danger small"></span>
                </div>
                <div class="col-md-6 form-group">
                    <label asp-for="ExpiryDate" class="form-label">Expiry Date</label>
                    <input type="date" asp-for="ExpiryDate" id="ExpiryDate" class="form-control" required value="@(Model.ExpiryDate?.ToString("yyyy-MM-dd"))" />
                    <span asp-validation-for="ExpiryDate" class="text-danger small"></span>
                </div>
                <div class="col-md-6 form-group">
                    <label asp-for="licensenumber" class="form-label">License Number</label>
                    <input asp-for="licensenumber" class="form-control" maxlength="30" />
                    <span asp-validation-for="licensenumber" class="text-danger small"></span>
                </div>
                <div class="col-md-12 form-group">
                    <label asp-for="Note" class="form-label">Note</label>
                    <textarea asp-for="Note" class="form-control" rows="2">@Model.Note</textarea>
                    <span asp-validation-for="Note" class="text-danger small"></span>
                </div>
            </div>

            <!-- SECTION 3: PDF -->
            <div class="section-title">
                <i class="fa-solid fa-paperclip"></i> Attachment
            </div>
            <div class="section-divider"></div>
            <div class="row g-3">
                <div class="col-md-12 form-group">
                    <label asp-for="LicenseFile" class="form-label">License PDF</label>
                    <input asp-for="LicenseFile" type="file" class="form-control" id="LicenseFile" name="LicenseFile" />
                    <span asp-validation-for="LicenseFile" class="text-danger small"></span>
                    @if (!string.IsNullOrEmpty(Model.PDFPath))
                    {
                        <div class="mt-2 text-success small">Current PDF: <a href="@Url.Content(Model.PDFPath)" target="_blank">View/Download</a></div>
                    }
                </div>
            </div>

            <div class="col-12 text-end mt-3">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fa-solid fa-floppy-disk"></i> Save Changes
                </button>
                <a class="btn btn-secondary ms-2" href="@Url.Action("Index", "License")">
                    <i class="fa-solid fa-arrow-left"></i> Back to List
                </a>
            </div>
        </form>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
@section Scripts {
    <script>
        $(document ).ready(function () {
            function toggleExpiryDateField() {
                const licenseType = $('#LicenseType').val();
                const proficiencyLevel = $('#RANGE').val();
                const expiryDateDiv = $('#ExpiryDate').closest('.form-group');
                const expiryDateInput = $('#ExpiryDate');
                let expiryMessage = $('#expiry-message');
                const proficiencyLevelDiv = $('#proficiencyLevelDiv');

                if (!expiryMessage.length) {
                    expiryDateDiv.append('<div id="expiry-message" style="color: red; margin-top: 5px;"></div>');
                    expiryMessage = $('#expiry-message');
                }

                if (licenseType === 'English Proficiency Test') {
                    proficiencyLevelDiv.show();
                    if (proficiencyLevel === '6') {
                        expiryDateInput.prop('disabled', true).val('');
                        expiryMessage.text('This proficiency level does not have an expiry date.');
                    } else {
                        expiryDateInput.prop('disabled', false);
                        expiryMessage.text('');
                    }
                } else {
                    proficiencyLevelDiv.hide();
                    expiryDateInput.prop('disabled', false);
                    expiryMessage.text('');
                }
            }

            // تأكد من أن قيمة LicenseType يتم تعيينها بشكل صحيح عند تحميل الصفحة
            // يمكنك استخدام قيمة Model.LicenseType لتعيينها في JavaScript
            $('#LicenseType').val('@Model.LicenseType');

            $('#LicenseType').change(toggleExpiryDateField);
            $('#RANGE').change(toggleExpiryDateField);
            toggleExpiryDateField();
        });
    </script>
    <partial name="_ValidationScriptsPartial" />
}
